<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advance Analytics - JagaNetwork</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .kpi-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .nav-active { color: #4338ca; background-color: #eef2ff; font-weight: 600; }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="flex min-h-screen">
        <aside class="w-64 bg-white shadow-md flex-col p-4 hidden md:flex">
            <div class="p-4 mb-4"><h1 class="text-2xl font-bold text-indigo-600">Analytics</h1><p class="text-sm text-gray-500">JagaNetwork Platform</p></div>
            <nav id="sidebar-nav" class="flex-1 space-y-2">
                <a href="#ringkasan" class="nav-link nav-active flex items-center py-2 px-4 text-gray-700 rounded-lg"><i data-lucide="bar-chart-2" class="w-5 h-5 mr-3"></i> Ringkasan</a>
                <a href="#pendapatan" class="nav-link flex items-center py-2 px-4 text-gray-600 hover:bg-gray-100 rounded-lg"><i data-lucide="trending-up" class="w-5 h-5 mr-3"></i> Pendapatan</a>
                <a href="#pelanggan" class="nav-link flex items-center py-2 px-4 text-gray-600 hover:bg-gray-100 rounded-lg"><i data-lucide="users" class="w-5 h-5 mr-3"></i> Pelanggan</a>
                <a href="#pengeluaran" class="nav-link flex items-center py-2 px-4 text-gray-600 hover:bg-gray-100 rounded-lg"><i data-lucide="trending-down" class="w-5 h-5 mr-3"></i> Pengeluaran</a>
            </nav>
        </aside>

        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <header class="flex justify-between items-center mb-8">
                <h2 id="main-title" class="text-2xl md:text-3xl font-bold">Ringkasan Bisnis</h2>
                <div class="flex items-center gap-2"><i data-lucide="calendar" class="w-5 h-5 text-gray-500"></i><span id="current-date" class="text-gray-600 font-medium text-sm md:text-base"></span></div>
            </header>
            
            <div id="loading-indicator" class="text-center py-16"><p class="text-lg text-gray-600">Memuat data analitik...</p></div>

            <div id="analytics-content" class="hidden">
                <section id="ringkasan" class="mb-12">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Key Performance Indicators</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm flex items-start justify-between"><div><p class="text-sm text-gray-500">Monthly Recurring Revenue (MRR)</p><p id="kpi-mrr" class="text-3xl font-bold mt-1">Rp 0</p></div><div class="bg-indigo-100 text-indigo-600 p-3 rounded-full"><i data-lucide="dollar-sign" class="w-6 h-6"></i></div></div>
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm flex items-start justify-between"><div><p class="text-sm text-gray-500">Avg. Revenue Per User (ARPU)</p><p id="kpi-arpu" class="text-3xl font-bold mt-1">Rp 0</p></div><div class="bg-green-100 text-green-600 p-3 rounded-full"><i data-lucide="user-check" class="w-6 h-6"></i></div></div>
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm flex items-start justify-between"><div><p class="text-sm text-gray-500">Pelanggan Aktif</p><p id="kpi-active-customers" class="text-3xl font-bold mt-1">0</p></div><div class="bg-blue-100 text-blue-600 p-3 rounded-full"><i data-lucide="users" class="w-6 h-6"></i></div></div>
                        <div class="kpi-card bg-white p-6 rounded-lg shadow-sm flex items-start justify-between"><div><p class="text-sm text-gray-500">Churn Rate (Bulan Ini)</p><p id="kpi-churn-rate" class="text-3xl font-bold mt-1">0%</p></div><div class="bg-red-100 text-red-600 p-3 rounded-full"><i data-lucide="user-x" class="w-6 h-6"></i></div></div>
                    </div>
                </section>

                <section id="bep" class="mb-12">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Alat Bantu Bisnis RT/RW Net</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        
                        <div class="bg-white p-6 rounded-lg shadow-sm flex flex-col">
                            <h4 class="text-lg font-semibold mb-4">Kalkulator Break-Even Point (BEP)</h4>
                            <div class="space-y-4 flex-grow">
                                <div><label for="initial-investment" class="block text-sm font-medium text-gray-700">Total Investasi Awal (Alat)</label><input type="number" id="initial-investment" class="w-full mt-1 p-2 border border-gray-300 rounded-md" placeholder="Contoh: 5000000"></div>
                                <div><label for="lifespan" class="block text-sm font-medium text-gray-700">Masa Pakai Alat (Bulan)</label><input type="number" id="lifespan" class="w-full mt-1 p-2 border border-gray-300 rounded-md" placeholder="Contoh: 24"></div>
                                <div><label for="isp-cost" class="block text-sm font-medium text-gray-700">Langganan Internet Utama (per bulan)</label><input type="number" id="isp-cost" class="w-full mt-1 p-2 border border-gray-300 rounded-md" placeholder="Contoh: 1000000"></div>
                                <div><label for="ops-cost" class="block text-sm font-medium text-gray-700">Biaya Operasional Lain (per bulan)</label><input type="number" id="ops-cost" class="w-full mt-1 p-2 border border-gray-300 rounded-md" placeholder="Contoh: 150000"></div>
                                <div><label for="subscription-price" class="block text-sm font-medium text-gray-700">Harga Paket Langganan</label><input type="number" id="subscription-price" class="w-full mt-1 p-2 border border-gray-300 rounded-md" placeholder="Contoh: 150000"></div>
                            </div>
                            <button id="calculate-bep-btn" class="mt-6 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Hitung BEP</button>
                             <div class="text-center mt-4"><p class="text-sm text-gray-500">Target Impas: <span id="bep-result" class="font-bold text-indigo-600">- Pelanggan</span></p></div>
                        </div>
                
                        <div class="bg-white p-6 rounded-lg shadow-sm flex flex-col">
                            <h4 class="text-lg font-semibold mb-4">Kalkulator Cek Profitabilitas</h4>
                            <p class="text-sm text-gray-600 mb-4">Fitur ini menggunakan data biaya dari kalkulator BEP di sebelah kiri.</p>
                            <div class="space-y-4 flex-grow">
                                <div>
                                    <label for="actual-revenue" class="block text-sm font-medium text-gray-700">Total Pendapatan Aktual Bulan Ini</label>
                                    <input type="number" id="actual-revenue" class="w-full mt-1 p-2 border border-gray-300 rounded-md" placeholder="Masukkan total omzet Anda">
                                </div>
                            </div>
                            <button id="calculate-profit-btn" class="mt-6 w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700">Cek Profitabilitas</button>
                            <div id="profit-result-card" class="text-center mt-4 p-4 rounded-lg bg-gray-50 hidden">
                                <p class="text-sm font-medium text-gray-500">Status Keuangan Bulan Ini</p>
                                <p id="profit-status" class="text-2xl font-bold my-1">-</p>
                                <p id="profit-amount" class="text-lg font-semibold">-</p>
                            </div>
                        </div>

                    </div>
                </section>
                
                <section id="pendapatan" class="mb-12"></section>
                <section id="pelanggan" class="mb-12"></section>
                <section id="pengeluaran" class="mb-12"></section>
            </div>
        </main>
    </div>

    <script type="module">
        // ... (Kode Firebase dan fungsi-fungsi lainnya tetap sama) ...
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const firebaseConfig={apiKey:"AIzaSyBeuxfhsPRqd3NJTp0zUfnuZGJEKLBh3g0",authDomain:"database-jaganetwork.firebaseapp.com",projectId:"database-jaganetwork",storageBucket:"database-jaganetwork.appspot.com",messagingSenderId:"912989992875",appId:"1:912989992875:web:8c6cda77171889e1e644ee"};
        const app=initializeApp(firebaseConfig);const db=getFirestore(app);const auth=getAuth(app);
        const dataContainerPath="jaganetwork_data/shared_workspace";const getCollectionRef=name=>query(collection(db,dataContainerPath,name));
        const formatRupiah=angka=>!angka&&angka!==0?'Rp 0':new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(angka);
        async function fetchData(){/*... Code ...*/}
        function calculateAnalytics(data){/*... Code ...*/}
        function prepareChartData(data){/*... Code ...*/}
        function renderCharts(chartData){/*... Code ...*/}
        onAuthStateChanged(auth,user=>{/*... Code ...*/});
        document.getElementById('sidebar-nav').addEventListener('click',function(e){/*... Code ...*/});
        
        // --- Logika Kalkulator Bisnis ---
        const calculateBepBtn = document.getElementById('calculate-bep-btn');
        const bepResultEl = document.getElementById('bep-result');
        
        // Fungsi untuk mengambil dan memvalidasi semua input biaya
        function getCostInputs() {
            const initialInvestment = parseFloat(document.getElementById('initial-investment').value);
            const lifespan = parseFloat(document.getElementById('lifespan').value);
            const ispCost = parseFloat(document.getElementById('isp-cost').value);
            const opsCost = parseFloat(document.getElementById('ops-cost').value);
            const subscriptionPrice = parseFloat(document.getElementById('subscription-price').value);

            const allInputsValid = !isNaN(initialInvestment) && !isNaN(lifespan) && !isNaN(ispCost) && !isNaN(opsCost) && !isNaN(subscriptionPrice);
            if (!allInputsValid || lifespan <= 0 || subscriptionPrice <= 0) {
                return null; // Mengembalikan null jika ada input tidak valid
            }
            return { initialInvestment, lifespan, ispCost, opsCost, subscriptionPrice };
        }

        // Event Listener untuk Kalkulator BEP
        calculateBepBtn.addEventListener('click', function() {
            const costs = getCostInputs();
            if (!costs) {
                bepResultEl.textContent = 'Data tidak valid!';
                return;
            }
            const monthlyDepreciation = costs.initialInvestment / costs.lifespan;
            const totalFixedCosts = costs.ispCost + costs.opsCost + monthlyDepreciation;
            const bepInUnits = Math.ceil(totalFixedCosts / costs.subscriptionPrice);
            bepResultEl.textContent = `${bepInUnits.toLocaleString('id-ID')} Pelanggan`;
        });

        // [BARU] Event Listener untuk Kalkulator Profitabilitas
        const calculateProfitBtn = document.getElementById('calculate-profit-btn');
        const profitResultCard = document.getElementById('profit-result-card');
        const profitStatusEl = document.getElementById('profit-status');
        const profitAmountEl = document.getElementById('profit-amount');

        calculateProfitBtn.addEventListener('click', function() {
            const costs = getCostInputs();
            const actualRevenue = parseFloat(document.getElementById('actual-revenue').value);

            if (!costs || isNaN(actualRevenue)) {
                profitResultCard.classList.remove('hidden');
                profitStatusEl.textContent = 'Data Biaya / Pendapatan tidak valid!';
                profitAmountEl.textContent = '-';
                return;
            }

            const monthlyDepreciation = costs.initialInvestment / costs.lifespan;
            const totalFixedCosts = costs.ispCost + costs.opsCost + monthlyDepreciation;
            const profitOrLoss = actualRevenue - totalFixedCosts;

            // Tampilkan kartu hasil
            profitResultCard.classList.remove('hidden');
            
            // Hapus class warna sebelumnya
            profitStatusEl.classList.remove('text-green-600', 'text-red-600', 'text-gray-600');

            if (profitOrLoss > 0) {
                profitStatusEl.textContent = 'Untung';
                profitStatusEl.classList.add('text-green-600');
                profitAmountEl.textContent = `+ ${formatRupiah(profitOrLoss)}`;
            } else if (profitOrLoss < 0) {
                profitStatusEl.textContent = 'Rugi';
                profitStatusEl.classList.add('text-red-600');
                profitAmountEl.textContent = `- ${formatRupiah(Math.abs(profitOrLoss))}`;
            } else {
                profitStatusEl.textContent = 'Impas';
                profitStatusEl.classList.add('text-gray-600');
                profitAmountEl.textContent = formatRupiah(0);
            }
        });

        lucide.createIcons();
    </script>
</body>
</html>
